generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum TriggerSource {
  SCHEDULE
  MANUAL
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum BridgeValueType {
  NUMBER @map("number")
  TEXT   @map("text")
  DATE   @map("date")
}

model User {
  userId           String        @id @default(cuid())
  empcode          String?
  displayName      String
  firstName        String        @default("")
  lastName         String        @default("")
  email            String        @unique
  password         String
  phone            String?
  department       String[]      @default([])
  avatar           String?
  roles            String[]      @default(["user"])
  status           UserStatus    @default(ACTIVE)
  emailVerified    Boolean       @default(false)
  emailVerifiedAt DateTime?
  emailVerifyToken String?
  lastLogin        DateTime?
  nextLogin        DateTime?
  options          Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  groupMembers     GroupMember[]

  @@index([empcode])
  @@index([status])
  @@index([createdAt])
  @@index([displayName])
  @@index([lastName, firstName])
  @@index([nextLogin])
  @@map("users")
}

model Group {
  groupId     String        @id @default(cuid())
  groupName   String        @unique
  description String        @default("")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     GroupMember[]

  @@map("groups")
}

model GroupMember {
  groupId    String
  userId     String
  createdAt  DateTime @default(now())
  group      Group    @relation(fields: [groupId], references: [groupId], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@id([groupId, userId])
  @@index([userId])
  @@map("group_members")
}

model AutomationSchedule {
  scheduleId    String                 @id @default(cuid())
  scheduleName  String
  action        Int                    @db.SmallInt
  hour          Int
  minute        Int
  daysOfWeek    Int[]                  @default([0, 1, 2, 3, 4, 5, 6])
  isActive      Boolean                @default(true)
  createdBy     String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  devices       ScheduleHardware[]

  @@index([isActive])
  @@index([hour, minute])
  @@map("automation_schedules")
}

model Device {
  deviceId      String             @id @default(cuid())
  deviceName    String
  description   String             @default("")
  isActive      Boolean            @default(true)
  createdBy     String?
  deviceSecretHash String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  schedules     ScheduleHardware[]

  @@index([deviceName])
  @@index([isActive])
  @@index([createdBy])
  @@map("devices")
}

model ScheduleHardware {
  scheduleId    String
  deviceId      String
  pinNumber     Int
  duration      Int?
  createdAt     DateTime           @default(now())
  schedule      AutomationSchedule @relation(fields: [scheduleId], references: [scheduleId], onDelete: Cascade)
  device        Device             @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@id([scheduleId, deviceId, pinNumber])
  @@index([deviceId])
  @@map("schedule_hardware")
}

model AutomationExecutionLog {
  executionId    String             @id @default(cuid())
  scheduleId     String?
  triggerSource  TriggerSource
  status         ExecutionStatus
  action         Int                @db.SmallInt
  executionKey   String?            @unique
  requestedBy    String?
  startedAt      DateTime           @default(now())
  finishedAt     DateTime?
  resultMessage  String?

  @@index([scheduleId, startedAt])
  @@index([triggerSource, startedAt])
  @@map("automation_execution_logs")
}

model ConfigType {
  typCode         String         @id @map("typ_code")
  typDescription  String         @default("") @map("typ_description")
  details         ConfigDetail[]
  bridges         CommonBridge[]

  @@map("config_types")
}

model ConfigDetail {
  typCode          String      @map("typ_code")
  confCode         String      @map("conf_code")
  confDescription  String      @default("") @map("conf_description")
  confName         String      @map("conf_name")
  confValue        String?     @map("conf_value")
  configType       ConfigType  @relation(fields: [typCode], references: [typCode], onDelete: Cascade)

  @@id([typCode, confCode])
  @@index([typCode])
  @@map("config_details")
}

model CommonBridge {
  brdgGroupCode  String          @map("brdg_group_code")
  leftCode       String          @map("left_code")
  rightCode      String          @map("right_code")
  brdgValue      String?         @map("brdg_value")
  brdgType       BridgeValueType @default(TEXT) @map("brdg_type")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  configType     ConfigType      @relation(fields: [brdgGroupCode], references: [typCode], onDelete: Cascade)

  @@id([brdgGroupCode, leftCode, rightCode])
  @@index([leftCode])
  @@index([rightCode])
  @@map("common_bridges")
}
